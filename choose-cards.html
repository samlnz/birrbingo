<!-- choose-cards.html - Updated for mobile -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Choose Bingo Cards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/animations.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Mobile-optimized styles */
        :root {
            --card-size: 70px;
        }
        
        @media (max-width: 480px) {
            :root {
                --card-size: 65px;
            }
        }
        
        @media (max-width: 360px) {
            :root {
                --card-size: 55px;
            }
        }
        
        /* Add to existing styles */
        .mobile-header {
            position: sticky;
            top: 0;
            background: rgba(10, 10, 10, 0.95);
            z-index: 100;
            padding: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .mobile-timer {
            font-size: 1.8rem;
            text-align: center;
            margin: 10px 0;
        }
        
        .cards-grid-container {
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="choose-cards-page">
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="player-avatar" id="playerAvatar">T</div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-light);">Playing for</div>
                    <div style="font-size: 1.1rem; color: var(--accent); font-weight: bold;">10 BIRR</div>
                </div>
            </div>
            <div class="selection-timer">
                <div style="font-size: 0.8rem; color: #ff9999; margin-bottom: 5px;">TIME LEFT</div>
                <div class="mobile-timer" id="mobileTimer">01:00</div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px;">
            <div>
                <div style="font-size: 0.8rem; color: var(--text-light);">Cards Selected</div>
                <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;" id="selectedCount">0/2</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-light);">Prize Pool</div>
                <div style="font-size: 1.2rem; color: var(--accent); font-weight: bold;" id="currentPrizePool">0 BIRR</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-light);">Players</div>
                <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;" id="currentPlayers">0</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="game-container" style="padding: 15px;">
        <!-- Selected Cards Preview -->
        <div class="selected-cards-section" style="margin-bottom: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem;">
                <i class="fas fa-check-circle"></i> YOUR SELECTED CARDS
            </h3>
            <div class="selected-cards">
                <div class="selected-card-display" id="card1Display">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="color: var(--text-light); font-size: 0.9rem;">CARD #1</div>
                        <div class="card-number" id="card1Number">--</div>
                    </div>
                    <div class="card-preview" id="card1Preview"></div>
                </div>
                
                <div class="selected-card-display" id="card2Display">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="color: var(--text-light); font-size: 0.9rem;">CARD #2</div>
                        <div class="card-number" id="card2Number">--</div>
                    </div>
                    <div class="card-preview" id="card2Preview"></div>
                </div>
            </div>
        </div>
        
        <!-- Cards Grid -->
        <div style="margin-bottom: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-th-large"></i>
                CHOOSE YOUR CARDS (1-500)
            </h3>
            <div class="cards-grid-container">
                <div class="cards-grid" id="cardsGrid">
                    <!-- Cards will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls-section" style="margin-top: 20px;">
            <button class="control-btn btn-random" id="randomSelectBtn" style="padding: 15px; font-size: 1rem;">
                <i class="fas fa-random"></i>
                RANDOM SELECT
            </button>
            
            <button class="control-btn btn-clear" id="clearSelectionBtn" style="padding: 15px; font-size: 1rem;">
                <i class="fas fa-trash-alt"></i>
                CLEAR
            </button>
            
            <button class="control-btn btn-confirm" id="confirmSelectionBtn" disabled style="padding: 15px; font-size: 1rem; background: linear-gradient(135deg, #4CAF50, #2E7D32);">
                <i class="fas fa-check-double"></i>
                CONFIRM & PLAY
            </button>
        </div>
        
        <!-- Instructions -->
        <div class="instructions" style="margin-top: 20px; font-size: 0.9rem;">
            <p style="color: var(--text-light); line-height: 1.4;">
                <i class="fas fa-exclamation-triangle" style="color: var(--accent);"></i>
                <strong>Important:</strong> Once game starts, numbers will be called every 5 seconds. 
                Only valid BINGO lines with called numbers count. False claims result in disqualification.
            </p>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading Game...</div>
    </div>

    <!-- Scripts -->
    <script src="js/game-state.js"></script>
    <script src="js/bingo-cards.js"></script>
    <script src="js/real-player.js"></script>
    <script src="js/telegram-api.js"></script>
    <script>
        // Initialize Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Game state
        const gameState = {
            selectedCards: [],
            maxCards: 2,
            takenCards: new Set(),
            selectionTime: 60, // 1 minute timer
            timerInterval: null,
            playerId: null,
            playerName: 'Player'
        };
        
        // DOM elements
        const cardsGrid = document.getElementById('cardsGrid');
        const card1Number = document.getElementById('card1Number');
        const card2Number = document.getElementById('card2Number');
        const card1Preview = document.getElementById('card1Preview');
        const card2Preview = document.getElementById('card2Preview');
        const selectedCount = document.getElementById('selectedCount');
        const randomSelectBtn = document.getElementById('randomSelectBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const confirmSelectionBtn = document.getElementById('confirmSelectionBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const playerAvatar = document.getElementById('playerAvatar');
        const mobileTimer = document.getElementById('mobileTimer');
        const currentPrizePool = document.getElementById('currentPrizePool');
        const currentPlayers = document.getElementById('currentPlayers');
        
        // Initialize
        function init() {
            // Get user info
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                gameState.playerName = user.first_name || 'Player';
                if (user.last_name) gameState.playerName += ' ' + user.last_name;
                gameState.playerId = user.id.toString();
                playerAvatar.textContent = gameState.playerName.charAt(0).toUpperCase();
            }
            
            // Load taken cards from real players
            loadTakenCards();
            
            // Create cards grid
            createCardGrid();
            
            // Start selection timer
            startSelectionTimer();
            
            // Update prize pool display
            updatePrizePool();
        }
        
        function loadTakenCards() {
            // Load real taken cards from player data
            const players = JSON.parse(localStorage.getItem('bingoPlayers') || '[]');
            players.forEach(player => {
                player.selectedCards.forEach(cardId => {
                    gameState.takenCards.add(cardId);
                });
            });
        }
        
        function createCardGrid() {
            cardsGrid.innerHTML = '';
            
            // Create cards 1-500
            for (let i = 1; i <= 500; i++) {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-number';
                cardElement.textContent = i;
                cardElement.dataset.cardNumber = i;
                
                if (gameState.takenCards.has(i)) {
                    cardElement.classList.add('taken');
                    cardElement.title = 'Taken by another player';
                } else {
                    cardElement.addEventListener('click', () => selectCard(i));
                }
                
                cardsGrid.appendChild(cardElement);
            }
        }
        
        function selectCard(cardNumber) {
            // Check if already selected
            if (gameState.selectedCards.includes(cardNumber)) {
                deselectCard(cardNumber);
                return;
            }
            
            // Check max cards
            if (gameState.selectedCards.length >= gameState.maxCards) {
                alert(`Maximum ${gameState.maxCards} cards allowed`);
                return;
            }
            
            // Add to selection
            gameState.selectedCards.push(cardNumber);
            updateSelectionDisplay();
        }
        
        function deselectCard(cardNumber) {
            const index = gameState.selectedCards.indexOf(cardNumber);
            if (index > -1) {
                gameState.selectedCards.splice(index, 1);
                updateSelectionDisplay();
            }
        }
        
        function updateSelectionDisplay() {
            // Update card numbers display
            card1Number.textContent = gameState.selectedCards[0] || '--';
            card2Number.textContent = gameState.selectedCards[1] || '--';
            
            // Update previews
            updateCardPreview(1, gameState.selectedCards[0]);
            updateCardPreview(2, gameState.selectedCards[1]);
            
            // Update selected count
            selectedCount.textContent = `${gameState.selectedCards.length}/${gameState.maxCards}`;
            
            // Update confirm button
            confirmSelectionBtn.disabled = gameState.selectedCards.length === 0;
            
            // Update card elements
            updateCardElements();
        }
        
        function updateCardPreview(cardIndex, cardNumber) {
            const previewElement = cardIndex === 1 ? card1Preview : card2Preview;
            previewElement.innerHTML = '';
            
            if (!cardNumber) {
                // Empty preview
                for (let i = 0; i < 25; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'preview-cell';
                    previewElement.appendChild(cell);
                }
                return;
            }
            
            // Get actual bingo card numbers
            const card = bingoCards.getCard(cardNumber);
            if (!card) return;
            
            // Create 5x5 grid
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'preview-cell';
                    
                    const number = card.numbers[row][col];
                    if (number === 'FREE') {
                        cell.textContent = 'FREE';
                        cell.classList.add('free');
                    } else {
                        cell.textContent = number;
                    }
                    
                    previewElement.appendChild(cell);
                }
            }
        }
        
        function updateCardElements() {
            document.querySelectorAll('.card-number').forEach(card => {
                const cardNum = parseInt(card.dataset.cardNumber);
                card.classList.remove('selected');
                
                if (gameState.selectedCards.includes(cardNum)) {
                    card.classList.add('selected');
                }
            });
        }
        
        function startSelectionTimer() {
            // Load timer from game state
            const gameData = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
            gameState.selectionTime = gameData.gameTimer || 60;
            
            updateTimerDisplay();
            
            gameState.timerInterval = setInterval(() => {
                gameState.selectionTime--;
                updateTimerDisplay();
                
                // Update global game state
                const updatedGameData = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
                updatedGameData.gameTimer = gameState.selectionTime;
                localStorage.setItem('bingoGameState', JSON.stringify(updatedGameData));
                
                if (gameState.selectionTime <= 0) {
                    clearInterval(gameState.timerInterval);
                    autoConfirmSelection();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.selectionTime / 60);
            const seconds = gameState.selectionTime % 60;
            mobileTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Color change for last 10 seconds
            if (gameState.selectionTime <= 10) {
                mobileTimer.style.color = 'var(--danger)';
                mobileTimer.classList.add('animate-pulse');
            }
        }
        
        function updatePrizePool() {
            const gameData = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
            const players = JSON.parse(localStorage.getItem('bingoPlayers') || '[]');
            
            currentPlayers.textContent = players.length;
            
            const totalStakes = players.length * 10; // 10 BIRR each
            const prizePool = Math.floor(totalStakes * 0.8);
            currentPrizePool.textContent = `${prizePool} BIRR`;
        }
        
        function randomSelect() {
            if (gameState.selectedCards.length >= gameState.maxCards) {
                clearSelection();
            }
            
            const availableCards = [];
            for (let i = 1; i <= 500; i++) {
                if (!gameState.takenCards.has(i) && !gameState.selectedCards.includes(i)) {
                    availableCards.push(i);
                }
            }
            
            if (availableCards.length === 0) {
                alert('No cards available!');
                return;
            }
            
            // Shuffle and select
            const cardsToSelect = Math.min(gameState.maxCards - gameState.selectedCards.length, availableCards.length);
            for (let i = 0; i < cardsToSelect; i++) {
                const randomIndex = Math.floor(Math.random() * availableCards.length);
                gameState.selectedCards.push(availableCards[randomIndex]);
                availableCards.splice(randomIndex, 1);
            }
            
            updateSelectionDisplay();
        }
        
        function clearSelection() {
            gameState.selectedCards = [];
            updateSelectionDisplay();
        }
        
        function confirmSelection() {
            if (gameState.selectedCards.length === 0) {
                alert('Please select at least one card');
                return;
            }
            
            loadingOverlay.classList.add('active');
            loadingText.textContent = 'Saving your selection...';
            
            // Register player with selected cards
            const playerData = {
                id: gameState.playerId,
                name: gameState.playerName,
                selectedCards: gameState.selectedCards,
                joinedAt: Date.now(),
                stakePaid: true
            };
            
            // Update players data
            const players = JSON.parse(localStorage.getItem('bingoPlayers') || '[]');
            const existingIndex = players.findIndex(p => p.id === gameState.playerId);
            
            if (existingIndex > -1) {
                players[existingIndex] = playerData;
            } else {
                players.push(playerData);
            }
            
            localStorage.setItem('bingoPlayers', JSON.stringify(players));
            
            // Update game state
            const gameData = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
            gameData.cardsTaken = players.reduce((total, player) => total + (player.selectedCards?.length || 0), 0);
            localStorage.setItem('bingoGameState', JSON.stringify(gameData));
            
            // Navigate to game
            setTimeout(() => {
                window.location.href = 'game.html';
            }, 1500);
        }
        
        function autoConfirmSelection() {
            if (gameState.selectedCards.length === 0) {
                randomSelect();
            }
            
            if (gameState.selectedCards.length > 0) {
                confirmSelection();
            }
        }
        
        // Event Listeners
        randomSelectBtn.addEventListener('click', randomSelect);
        clearSelectionBtn.addEventListener('click', clearSelection);
        confirmSelectionBtn.addEventListener('click', confirmSelection);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>