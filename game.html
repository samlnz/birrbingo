<!-- game.html - Updated for mobile with real validation -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/animations.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Mobile game layout */
        .game-mobile-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .caller-section-mobile {
            background: linear-gradient(135deg, #001219, #005f73);
            padding: 15px;
            border-bottom: 2px solid var(--primary);
            flex-shrink: 0;
        }
        
        .current-number-mobile {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
        }
        
        .called-numbers-mobile {
            max-height: 100px;
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            margin-top: 10px;
        }
        
        .called-number-mobile {
            display: inline-block;
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 8px;
            margin-right: 8px;
            font-weight: bold;
        }
        
        .player-cards-mobile {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .bingo-card-mobile {
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(0, 180, 216, 0.3);
        }
        
        .game-controls-mobile {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-top: 2px solid var(--primary);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .btn-bingo-mobile {
            flex: 2;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-bingo-mobile:disabled {
            opacity: 0.5;
        }
        
        .btn-auto-mobile {
            flex: 1;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1rem;
        }
        
        /* BINGO letters indicator */
        .bingo-letters {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .bingo-letter {
            text-align: center;
            flex: 1;
        }
        
        .letter {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .called-count {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        /* Winning line indicator */
        .winning-indicator-mobile {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid var(--success);
            border-radius: 15px;
            padding: 20px;
            z-index: 2000;
            text-align: center;
            display: none;
            width: 90%;
            max-width: 300px;
        }
        
        .winning-indicator-mobile.active {
            display: block;
            animation: popIn 0.3s ease;
        }
    </style>
</head>
<body class="game-page">
    <div class="game-mobile-layout">
        <!-- Caller Section -->
        <div class="caller-section-mobile">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="color: var(--text-light); font-size: 0.9rem;">
                    <i class="fas fa-bullhorn"></i> BINGO CALLER
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 10px; color: var(--primary);">
                    Next: <span id="nextCallMobile">5s</span>
                </div>
            </div>
            
            <div class="current-number-mobile" id="currentNumberMobile">00</div>
            <div style="text-align: center; color: var(--text-light); font-size: 0.9rem;" id="numberLetterMobile">
                Waiting for first number...
            </div>
            
            <!-- BINGO Letters Status -->
            <div class="bingo-letters">
                <div class="bingo-letter">
                    <div class="letter">B</div>
                    <div class="called-count" id="countB">0</div>
                </div>
                <div class="bingo-letter">
                    <div class="letter">I</div>
                    <div class="called-count" id="countI">0</div>
                </div>
                <div class="bingo-letter">
                    <div class="letter">N</div>
                    <div class="called-count" id="countN">0</div>
                </div>
                <div class="bingo-letter">
                    <div class="letter">G</div>
                    <div class="called-count" id="countG">0</div>
                </div>
                <div class="bingo-letter">
                    <div class="letter">O</div>
                    <div class="called-count" id="countO">0</div>
                </div>
            </div>
            
            <!-- Called Numbers -->
            <div class="called-numbers-mobile" id="calledNumbersMobile">
                <!-- Called numbers appear here -->
            </div>
        </div>
        
        <!-- Player Cards -->
        <div class="player-cards-mobile" id="playerCardsMobile">
            <!-- Cards will be loaded here -->
        </div>
        
        <!-- Game Controls -->
        <div class="game-controls-mobile">
            <button class="btn-auto-mobile" id="autoToggleMobile">
                <i class="fas fa-robot"></i> AUTO
            </button>
            <button class="btn-bingo-mobile" id="bingoBtnMobile" disabled>
                <i class="fas fa-trophy"></i> BINGO!
            </button>
        </div>
    </div>
    
    <!-- Winning Indicator -->
    <div class="winning-indicator-mobile" id="winningIndicator">
        <div style="font-size: 2rem; color: var(--success); margin-bottom: 15px;">
            <i class="fas fa-trophy"></i> LINE COMPLETE!
        </div>
        <div style="color: var(--text-light); margin-bottom: 20px; font-size: 0.9rem;" id="winningMessage">
            You have a winning line!
        </div>
        <button class="btn-bingo-mobile" id="claimBingoMobile" style="width: 100%;">
            <i class="fas fa-check-double"></i> CLAIM BINGO
        </button>
    </div>
    
    <!-- Audio -->
    <audio id="numberCallAudio" preload="auto">
        <source src="audio/number-call.mp3" type="audio/mpeg">
    </audio>
    <audio id="bingoAudio" preload="auto">
        <source src="audio/bingo.mp3" type="audio/mpeg">
    </audio>

    <!-- Scripts -->
    <script src="js/game-state.js"></script>
    <script src="js/bingo-cards.js"></script>
    <script src="js/real-player.js"></script>
    <script src="js/game-logic.js"></script>
    <script src="js/telegram-api.js"></script>
    <script>
        // Initialize Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Game state
        const gameState = {
            playerId: null,
            playerName: 'Player',
            selectedCards: [],
            calledNumbers: new Set(),
            markedNumbers: {},
            autoMarkEnabled: true,
            hasValidBingo: false,
            disqualified: false
        };
        
        // DOM elements
        const currentNumberMobile = document.getElementById('currentNumberMobile');
        const numberLetterMobile = document.getElementById('numberLetterMobile');
        const nextCallMobile = document.getElementById('nextCallMobile');
        const calledNumbersMobile = document.getElementById('calledNumbersMobile');
        const playerCardsMobile = document.getElementById('playerCardsMobile');
        const bingoBtnMobile = document.getElementById('bingoBtnMobile');
        const autoToggleMobile = document.getElementById('autoToggleMobile');
        const claimBingoMobile = document.getElementById('claimBingoMobile');
        const winningIndicator = document.getElementById('winningIndicator');
        const winningMessage = document.getElementById('winningMessage');
        
        // BINGO letter counters
        const countB = document.getElementById('countB');
        const countI = document.getElementById('countI');
        const countN = document.getElementById('countN');
        const countG = document.getElementById('countG');
        const countO = document.getElementById('countO');
        
        // Initialize
        function init() {
            // Get user info
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                gameState.playerId = user.id.toString();
                gameState.playerName = user.first_name || 'Player';
                if (user.last_name) gameState.playerName += ' ' + user.last_name;
            }
            
            // Load player's selected cards
            loadPlayerCards();
            
            // Load called numbers
            loadCalledNumbers();
            
            // Create player cards
            createPlayerCards();
            
            // Start game if not already started
            if (!bingoGame.gameActive) {
                bingoGame.startGame();
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Update BINGO letter counts
            updateBingoCounts();
        }
        
        function loadPlayerCards() {
            const players = JSON.parse(localStorage.getItem('bingoPlayers') || '[]');
            const player = players.find(p => p.id === gameState.playerId);
            
            if (player && player.selectedCards) {
                gameState.selectedCards = player.selectedCards;
                
                // Initialize marked numbers for each card
                gameState.selectedCards.forEach(cardId => {
                    gameState.markedNumbers[cardId] = new Set();
                });
            } else {
                // No cards selected, redirect back
                setTimeout(() => {
                    window.location.href = 'choose-cards.html';
                }, 2000);
            }
        }
        
        function loadCalledNumbers() {
            const gameData = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
            if (gameData.calledNumbers) {
                gameData.calledNumbers.forEach(num => {
                    gameState.calledNumbers.add(num);
                });
            }
        }
        
        function createPlayerCards() {
            playerCardsMobile.innerHTML = '';
            
            gameState.selectedCards.forEach(cardId => {
                const card = bingoCards.getCard(cardId);
                if (!card) return;
                
                const cardElement = createBingoCardElement(cardId, card);
                playerCardsMobile.appendChild(cardElement);
            });
        }
        
        function createBingoCardElement(cardId, cardData) {
            const cardElement = document.createElement('div');
            cardElement.className = 'bingo-card-mobile';
            cardElement.dataset.cardId = cardId;
            
            // Card header
            const headerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="color: var(--primary); font-size: 1rem; font-weight: bold;">
                        <i class="fas fa-dice"></i> CARD #${cardId}
                    </div>
                    <div style="background: rgba(0,180,216,0.2); padding: 5px 10px; border-radius: 8px; font-size: 0.9rem; color: var(--text-light);">
                        Marked: <span id="markedCount-${cardId}">0</span>/24
                    </div>
                </div>
            `;
            
            // BINGO headers
            const headersHTML = `
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 8px;">
                    <div style="text-align: center; font-weight: bold; color: var(--primary); padding: 8px;">B</div>
                    <div style="text-align: center; font-weight: bold; color: var(--primary); padding: 8px;">I</div>
                    <div style="text-align: center; font-weight: bold; color: var(--primary); padding: 8px;">N</div>
                    <div style="text-align: center; font-weight: bold; color: var(--primary); padding: 8px;">G</div>
                    <div style="text-align: center; font-weight: bold; color: var(--primary); padding: 8px;">O</div>
                </div>
            `;
            
            // Card numbers grid
            let gridHTML = '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px;">';
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const number = cardData.numbers[row][col];
                    const isFree = number === 'FREE';
                    const isCalled = !isFree && gameState.calledNumbers.has(number);
                    const isMarked = gameState.markedNumbers[cardId]?.has(number);
                    
                    gridHTML += `
                        <div class="grid-cell-mobile ${isFree ? 'free' : ''} ${isCalled ? 'called' : ''} ${isMarked ? 'marked' : ''}"
                             data-card="${cardId}"
                             data-number="${isFree ? 'FREE' : number}"
                             data-row="${row}"
                             data-col="${col}"
                             onclick="toggleMark(${cardId}, ${isFree ? "'FREE'" : number})">
                            ${isFree ? 'FREE' : number}
                        </div>
                    `;
                }
            }
            
            gridHTML += '</div>';
            
            cardElement.innerHTML = headerHTML + headersHTML + gridHTML;
            updateMarkedCount(cardId);
            
            return cardElement;
        }
        
        function toggleMark(cardId, number) {
            if (number === 'FREE') return;
            if (gameState.disqualified) return;
            
            const markedSet = gameState.markedNumbers[cardId];
            const isCalled = gameState.calledNumbers.has(number);
            
            if (!isCalled) {
                // Player tried to mark uncalled number - DISQUALIFY
                gameState.disqualified = true;
                bingoBtnMobile.disabled = true;
                bingoBtnMobile.innerHTML = '<i class="fas fa-times-circle"></i> DISQUALIFIED';
                bingoBtnMobile.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
                
                // Notify backend
                notifyDisqualification('Marked uncalled number');
                return;
            }
            
            if (markedSet.has(number)) {
                markedSet.delete(number);
            } else {
                markedSet.add(number);
            }
            
            updateMarkedCount(cardId);
            checkForWinningLine(cardId);
            
            // Update UI
            const cell = document.querySelector(`[data-card="${cardId}"][data-number="${number}"]`);
            if (cell) {
                cell.classList.toggle('marked');
            }
        }
        
        function updateMarkedCount(cardId) {
            const count = gameState.markedNumbers[cardId]?.size || 0;
            const countElement = document.getElementById(`markedCount-${cardId}`);
            if (countElement) {
                countElement.textContent = count;
            }
        }
        
        function checkForWinningLine(cardId) {
            const calledNumbers = Array.from(gameState.calledNumbers);
            const winningLines = bingoCards.checkWinningLines(cardId, calledNumbers);
            
            if (winningLines.length > 0 && !gameState.hasValidBingo) {
                gameState.hasValidBingo = true;
                bingoBtnMobile.disabled = false;
                
                // Show winning indicator
                winningMessage.textContent = `Card #${cardId} has ${winningLines.length} winning line(s)!`;
                winningIndicator.classList.add('active');
                
                // Highlight winning cells
                highlightWinningCells(cardId, winningLines);
            } else if (winningLines.length === 0 && gameState.hasValidBingo) {
                gameState.hasValidBingo = false;
                bingoBtnMobile.disabled = true;
                winningIndicator.classList.remove('active');
            }
        }
        
        function highlightWinningCells(cardId, winningLines) {
            // Reset all highlights
            document.querySelectorAll(`[data-card="${cardId}"]`).forEach(cell => {
                cell.classList.remove('winning-cell');
            });
            
            // Apply highlights for winning lines
            winningLines.forEach(line => {
                const cells = getCellsForLine(cardId, line);
                cells.forEach(cell => {
                    if (cell) cell.classList.add('winning-cell');
                });
            });
        }
        
        function getCellsForLine(cardId, line) {
            const cells = [];
            
            if (line.startsWith('row')) {
                const row = parseInt(line.replace('row', ''));
                for (let col = 0; col < 5; col++) {
                    cells.push(document.querySelector(`[data-card="${cardId}"][data-row="${row}"][data-col="${col}"]`));
                }
            } else if (line.startsWith('col')) {
                const col = parseInt(line.replace('col', ''));
                for (let row = 0; row < 5; row++) {
                    cells.push(document.querySelector(`[data-card="${cardId}"][data-row="${row}"][data-col="${col}"]`));
                }
            } else if (line === 'diag1') {
                for (let i = 0; i < 5; i++) {
                    cells.push(document.querySelector(`[data-card="${cardId}"][data-row="${i}"][data-col="${i}"]`));
                }
            } else if (line === 'diag2') {
                for (let i = 0; i < 5; i++) {
                    cells.push(document.querySelector(`[data-card="${cardId}"][data-row="${i}"][data-col="${4-i}"]`));
                }
            }
            
            return cells.filter(cell => cell);
        }
        
        function setupEventListeners() {
            // Listen for called numbers
            window.addEventListener('bingoNumberCalled', (event) => {
                const { number, letter } = event.detail;
                
                // Update current number display
                currentNumberMobile.textContent = number.toString().padStart(2, '0');
                numberLetterMobile.textContent = `${letter}-${number}`;
                
                // Add to called numbers
                gameState.calledNumbers.add(number);
                updateCalledNumbersDisplay();
                updateBingoCounts();
                
                // Auto-mark if enabled
                if (gameState.autoMarkEnabled) {
                    autoMarkNumber(number);
                }
            });
            
            // Listen for winner
            window.addEventListener('bingoWinner', (event) => {
                const { playerName, cardId, prizeAmount } = event.detail;
                
                if (gameState.playerName === playerName) {
                    // Current player is winner
                    setTimeout(() => {
                        window.location.href = `winner.html?winner=${gameState.playerId}&prize=${prizeAmount}`;
                    }, 1000);
                } else {
                    // Another player won
                    setTimeout(() => {
                        window.location.href = 'choose-cards.html';
                    }, 5000); // Show for 5 seconds then redirect
                }
            });
            
            // Listen for disqualification
            window.addEventListener('playerDisqualified', (event) => {
                const { playerName, reason } = event.detail;
                
                if (gameState.playerName === playerName) {
                    gameState.disqualified = true;
                    bingoBtnMobile.disabled = true;
                    bingoBtnMobile.innerHTML = '<i class="fas fa-times-circle"></i> DISQUALIFIED';
                    bingoBtnMobile.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
                    
                    // Show message
                    alert(`Disqualified: ${reason}`);
                }
            });
            
            // Auto toggle button
            autoToggleMobile.addEventListener('click', () => {
                gameState.autoMarkEnabled = !gameState.autoMarkEnabled;
                autoToggleMobile.innerHTML = gameState.autoMarkEnabled ? 
                    '<i class="fas fa-robot"></i> AUTO ON' :
                    '<i class="fas fa-robot"></i> AUTO OFF';
                autoToggleMobile.style.background = gameState.autoMarkEnabled ? 
                    'var(--secondary)' : 'var(--danger)';
            });
            
            // BINGO claim button
            claimBingoMobile.addEventListener('click', claimBingo);
            bingoBtnMobile.addEventListener('click', () => {
                winningIndicator.classList.add('active');
            });
            
            // Update next call timer
            setInterval(() => {
                const gameData = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
                const lastUpdate = gameData.lastUpdated || 0;
                const timeSinceLast = Date.now() - lastUpdate;
                const nextCall = Math.max(0, 5000 - (timeSinceLast % 5000));
                
                nextCallMobile.textContent = `${Math.ceil(nextCall / 1000)}s`;
            }, 1000);
        }
        
        function autoMarkNumber(number) {
            gameState.selectedCards.forEach(cardId => {
                const card = bingoCards.getCard(cardId);
                if (card && card.flatNumbers.includes(number)) {
                    if (!gameState.markedNumbers[cardId].has(number)) {
                        gameState.markedNumbers[cardId].add(number);
                        
                        // Update UI
                        const cell = document.querySelector(`[data-card="${cardId}"][data-number="${number}"]`);
                        if (cell) {
                            cell.classList.add('marked');
                        }
                        
                        updateMarkedCount(cardId);
                        checkForWinningLine(cardId);
                    }
                }
            });
        }
        
        function updateCalledNumbersDisplay() {
            calledNumbersMobile.innerHTML = '';
            
            const sortedNumbers = Array.from(gameState.calledNumbers).sort((a, b) => a - b);
            sortedNumbers.forEach(number => {
                const numberElement = document.createElement('div');
                numberElement.className = 'called-number-mobile';
                numberElement.textContent = number;
                calledNumbersMobile.appendChild(numberElement);
            });
            
            // Scroll to end
            calledNumbersMobile.scrollLeft = calledNumbersMobile.scrollWidth;
        }
        
        function updateBingoCounts() {
            const counts = { B: 0, I: 0, N: 0, G: 0, O: 0 };
            
            gameState.calledNumbers.forEach(number => {
                const letter = bingoGame.getLetterForNumber(number);
                if (letter) counts[letter]++;
            });
            
            countB.textContent = counts.B;
            countI.textContent = counts.I;
            countN.textContent = counts.N;
            countG.textContent = counts.G;
            countO.textContent = counts.O;
        }
        
        function claimBingo() {
            if (gameState.disqualified) return;
            if (!gameState.hasValidBingo) return;
            
            // Find which card has the winning line
            let winningCardId = null;
            let winningLines = [];
            
            for (const cardId of gameState.selectedCards) {
                const lines = bingoCards.checkWinningLines(cardId, Array.from(gameState.calledNumbers));
                if (lines.length > 0) {
                    winningCardId = cardId;
                    winningLines = lines;
                    break;
                }
            }
            
            if (!winningCardId) {
                alert('No valid winning line found!');
                return;
            }
            
            // Validate with game logic
            bingoGame.declareBingo(gameState.playerId, winningCardId, winningLines, false);
        }
        
        function notifyDisqualification(reason) {
            const event = new CustomEvent('playerDisqualified', {
                detail: { playerId: gameState.playerId, playerName: gameState.playerName, reason: reason }
            });
            window.dispatchEvent(event);
        }
        
        // Make toggleMark available globally
        window.toggleMark = toggleMark;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <style>
        /* Additional mobile styles */
        .grid-cell-mobile {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .grid-cell-mobile.free {
            background: linear-gradient(135deg, #ff9e00, #ff7700);
            color: white;
            font-weight: bold;
        }
        
        .grid-cell-mobile.called {
            background: rgba(0, 180, 216, 0.2);
            border: 1px solid var(--primary);
        }
        
        .grid-cell-mobile.marked {
            background: linear-gradient(135deg, #00b4d8, #0077b6);
            color: white;
            transform: scale(1.05);
        }
        
        .grid-cell-mobile.winning-cell {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</body>
</html>